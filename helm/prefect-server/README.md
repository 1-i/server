# Prefect Server Helm Chart

## Usage

### Installing released versions

The Helm chart is automatically versioned and released alongside Server. 
For each Github Release of Server there is a corresponding version of the Helm chart.
The charts are hosted in a [Helm repository](https://helm.sh/docs/chart_repository/) deployed to the web courtesy of Github Pages.

1. Let you local Helm manager know about the repository.

    ```
    $ helm repo add prefecthq https://prefecthq.github.io/server/
    ```

2. Sync versions available in the repo to your local cache.

    ```
    $ helm repo update
    ```

3. Search for available charts and versions

    ```
    $ helm search repo [name]
    ```

4. Install the Helm chart

    ```
    $ helm install prefecthq/prefect-server --generate-name --verify
    ```

    _The verify flag is optional but will use gpg to verify the integrity of the chart package_

    _A name of your choice can be provided instead of --generate-name_


### Installing development versions

Development versions of the Helm chart will always be available directly from this Github repository.

1. Clone repository

2. Change to this directory

3. Download the postgresql dependency if you are not using an existing database

    ```
    $ helm dependency update
    ```

4. Install the chart

    ```
    $ helm install . --generate-name
    ```

### Upgrading

1. Look up the name of the last release

    ```
    $ helm list
    ```

2. Run the upgrade

    ```
    $ helm upgrade <name-of-last-release> prefecthq/prefect-server [--version <specific-tag>]
    ```
    for development versions, use
    ```
    $ helm upgrade <name-of-last-release> .
    ```

    _If a version is not provided, the latest version will be used_

**Important notes about upgrading**

This will only update infrastructure that is modified.
You will need to continue to set any values that you set during the original install (e.g. `--set agent.enabled=true`).
Note that if you are using the postgresql subchart with an autogenerated password, it will complain that you have not
provided that password for the upgrade.
Export the password as the error asks then set it within the subchart using `--set postgresql.postgresqlPassword=$POSTGRESQL_PASSWORD`


## Options:

See comments in `values.yaml`.

### Tenant
A tenant is needed for the server API to be operational.
If there is no tenant in the database, the UI dashboard will fail to display and agents will error.

To automatically create a default tenant, use the flag `--set jobs.createTenant.enabled=true`.

To create the tenant manually when your chart is already installed, 
run `prefect backend server && prefect server create-tenant --name default --slug default` to create a default tenant.
Check out [Connecting to your Server](#connecting-to-your-server) to connect your local `prefect` to your server before creating the tenant.

### KubernetesAgent

A [Prefect KubernetesAgent](https://docs.prefect.io/orchestration/agents/kubernetes.html) that queries for flows and runs them on your cluster can be installed but is not included by default.
Add the flag `--set agent.enabled=true` to the `helm install` command to include the agent.

### Database

The database can be deployed by this chart or be provided externally. 
We strongly recommend that you do not deploy a production database using this chart, the provided database is primarily for testing purposes.
The provided database will **not** persist your data by default.

An external database will require some minimal setup for Hasura.
The following needs to be run or the user should have permissions to execute it and Hasura will run it on startup:

```sql
CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE EXTENSION IF NOT EXISTS "pg_trgm";
SET TIME ZONE 'UTC';
```

## Versioning

The Helm chart in this repo is set to use the `latest` images for Prefect infrastructure by default.
The default `imagePullPolicy` is `Always` so these images will be updated when your deployments are rolled over.
This could result in some deployments being on mismatched versions which may not be guaranteed to work well together.
For production usage, we recommend setting the `prefectVersion` value to a specific tag to avoid unexpected upgrades.

When the Helm chart is published to a chart repository, we will pin the version for you.

##  Connecting to your Server

When you run `prefect backend server`, it configures the CLI to expect Server interactions rather than Prefect Cloud. By default, the CLI looks for the Server API at `localhost`. To connect the CLI to your newly deployed server, you'll either need to point the CLI to an external IP or forward the service to `localhost`
### Configure `prefect` to point to your service

To designate your local `prefect` to point to the Kubernetes server, 
you can change the host in the user configuration file `~/.prefect/config.toml`.

```
[server]
  host = "http://<EXTERNAL-IP>"
  [server.ui]
    apollo_url="http://<EXTERNAL-IP>:4200/graphql"
```
Run `kubectl get services --namespace <namespace>` to obtain the Apollo API external ip address.
To review the configuration file run `prefect config`.
 
### Forward your service to localhost 

Alternatively, you can port-forward the apollo service to your localhost 
`kubectl port-forward svc/<APOLO-SERVICE> 4200:4200 -n <namespace>`. 


## Troubleshooting

### The UI loads but the dashboard is blank

If you go to the 'Home' page, it will likely direct you to create a tenant. Without a tenant, the dashboard cannot display.

See the [Tenant](#tenant) section to learn how to create a default tenant.

### The UI loads but cannot connect to the API

Check that the API url is correct under the `server_url` key at the UI url `/settings.json` e.g. `http://localhost:8080/settings.json`.
This should match the url that the Apollo service is deployed to e.g. `http://localhost:4200/graphql`
This endpoint must be accessible by *the user* of the UI, not just the server, since requests come from the user's browser.

### The database deploys correctly but other services fail with "bad password"

If you are using the subchart deployed database with persistence enabled, 
it is likely the password for the user has persisted between deployments in the PVC for the database but the secret has been regenerated by the Helm chart and does not match. 
Deploy and set the 'postgresql.existingSecret' option or set a constant password at `postgresql.postgresqlPassword`.

### The agent is running but when I look at the logs I am getting GraphQL errors

The following error is typically caused by the lack of a tenant. Create a default tenant and the agent will restart automatically.
```
[2020-11-13 19:16:02,083] ERROR - agent | 400 Client Error: Bad Request for url: http://my-release-apollo.default:4200/graphql

This is likely caused by a poorly formatted GraphQL query or mutation. GraphQL sent:

query {
    mutation($input: get_runs_in_queue_input!) {
            get_runs_in_queue(input: $input) {
                flow_run_ids
        }
    }
}
variables {
    {"input": {"before": "2020-11-13T19:16:01.973734+00:00", "labels": [], "tenant_id": null}}
}
```

### Upgrading Hasura

If you are using managed database (e.g. Cloud SQL) and upgrading hasura image version to 1.3.3, make sure that hasura user is the owner of hdb_catalog schema. 
You can find [more details in hasura documentation](https://hasura.io/docs/1.0/graphql/core/deployment/postgres-requirements.html#notes-for-managed-databases-aws-rds-gcp-cloud-sql-etc).

Moreover, double check if hasura user owns hdb_catalog.insert_event_log function. 
To check functions ownership, run following SQL query: 
```
SELECT proname, proowner::regrole FROM pg_proc WHERE pronamespace::regnamespace::text = 'hdb_catalog';
```

To change function ownership, run: 
```
ALTER FUNCTION hdb_catalog.insert_event_log OWNER TO hasura;
```
